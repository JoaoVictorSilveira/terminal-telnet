<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Telnet</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #121212; color: #f0f0f0; padding: 20px; }
        h1, h2, h3 { text-align: center; margin-bottom: 20px; color: #1f8ef1; }
        .container { max-width: 950px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .connection, .vars, .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        label { margin-right: 5px; align-self: center; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #555; background: #2a2a2a; color: #fff; }
        button { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; background: #1f8ef1; color: #fff; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0d6efd; }
        #telnetOutput { background: #000; color: #0f0; padding: 15px; height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid #0f0; font-family: monospace; }
        @media (max-width: 600px) {
            .connection, .vars, .buttons { flex-direction: column; align-items: stretch; }
            input, button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Console Telnet</h1>

        <!-- Conexão -->
        <div class="connection">
            <label>IP:</label><input type="text" id="ip" value="">
            <label>Porta:</label><input type="text" id="port" value="">
            <button onclick="connectTelnet()">Conectar</button>
            <button onclick="disconnectTelnet()">Desconectar</button>
        </div>

        <!-- Variáveis -->
        <div class="vars">
            <label>PON:</label><input type="text" id="var1">
            <label>Posição ONU:</label><input type="text" id="var2">
            <label>ID:</label><input type="text" id="var3">
            <label>Código do Cliente:</label><input type="text" id="var4">
        </div>

        <!-- Botões de comandos -->
        <div class="buttons">
            <button id="adminBtn">Login</button>
            <button id="onuShowBtn">Ver ONUs Desautorizadas</button>
            <button id="AutorizarOnt">Autorizar ONT</button>
            <button id="AutorizarOnu">Autorizar ONU</button>
            <button id="Deletar">Deletar ONT/ONU</button>
            <button id="Status">Status ONT/ONU</button>
            <button id="verDescricao">Ver Descrição</button>
            <button id="stopUpdate">Parar Atualização</button>
            <button id="resumeUpdate">Retomar Atualização</button>
        </div>

        <h3>Saída Telnet</h3>
        <div id="telnetOutput"></div>
    </div>

    <script>
        let outputInterval = null; // variável global para setInterval

        async function connectTelnet() {
            const ip = document.getElementById('ip').value;
            const port = document.getElementById('port').value;
            const res = await fetch('/connect_telnet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ip: ip, port: port}),
                cache: 'no-store'
            });
            const data = await res.json();
            alert(data.message);
        }

        async function disconnectTelnet() {
            const res = await fetch('/disconnect_telnet', {method: 'POST'});
            const data = await res.json();
            alert(data.message);
            document.getElementById('telnetOutput').innerText = "";
        }

        async function sendCommand(cmd) {
            await fetch('/send_command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command: cmd}),
                cache: 'no-store'
            });
        }

        async function updateOutput() {
            const res = await fetch('/get_output', {cache: 'no-store'});
            const data = await res.json();
            const output = document.getElementById('telnetOutput');
            output.innerText = data.output;
            output.scrollTop = output.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Login admin
            document.getElementById('adminBtn').addEventListener('click', async () => {
                const commands = ['admin', 'admin'];
                for (const cmd of commands) {
                    await sendCommand(cmd);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            });

            // Ver ONUs desautorizadas
            document.getElementById('onuShowBtn').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                if (!v1) { alert("Preencha a variável PON."); return; }
                await sendCommand(`onu show gpon ${v1}`);
            });

            // Autorizar ONT
            document.getElementById('AutorizarOnt').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                const v2 = document.getElementById('var2').value;
                const v3 = document.getElementById('var3').value;
                const v4 = document.getElementById('var4').value;
                if (!v1 || !v2 || !v3 || !v4) {
                    alert("Preencha todas as variáveis: PON, Posição ONU, ID e Código do Cliente.");
                    return;
                }
                await sendCommand(`onu set gpon ${v1} onu ${v2} id ${v3} meprof intelbras-1200r`);
                await new Promise(r => setTimeout(r, 500));
                await sendCommand(`bridge add gpon ${v1} onu ${v2} downlink vlan 10${v1} tagged router`);
                await new Promise(r => setTimeout(r, 500));
                await sendCommand(`onu description add gpon ${v1} onu ${v2} text INET${v4}`);
            });

            // Autorizar ONU
            document.getElementById('AutorizarOnu').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                const v2 = document.getElementById('var2').value;
                const v3 = document.getElementById('var3').value;
                const v4 = document.getElementById('var4').value;
                if (!v1 || !v2 || !v3 || !v4) {
                    alert("Preencha todas as variáveis: PON, Posição ONU, ID e Código do Cliente.");
                    return;
                }
                await sendCommand(`onu set gpon ${v1} onu ${v2} id ${v3} meprof intelbras-110`);
                await new Promise(r => setTimeout(r, 500));
                await sendCommand(`bridge add gpon ${v1} onu ${v2} downlink vlan 10${v1} tagged eth 1`);
                await new Promise(r => setTimeout(r, 500));
                await sendCommand(`onu description add gpon ${v1} onu ${v2} text INET${v4}`);
            });

            // Deletar ONU/ONT
            document.getElementById('Deletar').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                const v2 = document.getElementById('var2').value;
                if (!v1 || !v2) { alert("Preencha PON e Posição ONU."); return; }
                await sendCommand(`onu delete gpon ${v1} onu ${v2}`);
                await new Promise(r => setTimeout(r, 500));
                await sendCommand('yes');
                await new Promise(r => setTimeout(r, 500));
                await sendCommand('no');
                await new Promise(r => setTimeout(r, 500));
                await sendCommand('yes');
            });

            // Status ONT/ONU
            document.getElementById('Status').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                if (!v1) { alert("Preencha a variável PON."); return; }
                await sendCommand(`onu status gpon ${v1}`);
            });

            // Ver descrição
            document.getElementById('verDescricao').addEventListener('click', async () => {
                const v1 = document.getElementById('var1').value;
                if (!v1) { alert("Preencha a variável PON."); return; }
                await sendCommand(`onu description show gpon ${v1}`);
            });

            // Atualização automática
            outputInterval = setInterval(updateOutput, 1000);

            // Parar atualização
            document.getElementById('stopUpdate').addEventListener('click', () => {
                if (outputInterval) {
                    clearInterval(outputInterval);
                    outputInterval = null;
                    alert("Atualização de saída parada!");
                }
            });

            // Retomar atualização
            document.getElementById('resumeUpdate').addEventListener('click', () => {
                if (!outputInterval) {
                    outputInterval = setInterval(updateOutput, 1000);
                    alert("Atualização de saída retomada!");
                }
            });
        });
    </script>
</body>
</html>
